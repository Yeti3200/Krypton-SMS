<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Started - Krypton Outreach</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Welcome to Krypton SMS!</h1>
                <div class="text-right">
                    <p class="text-lg font-semibold text-gray-800">{{ user.name }}</p>
                    <p class="text-sm text-gray-600">{{ user.email }}</p>
                </div>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Quick Setup</h2>
                <span class="text-sm text-gray-600">Step <span id="current-step">1</span> of 3</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 33%"></div>
            </div>
            <div class="flex justify-between mt-2 text-sm text-gray-600">
                <span>Upload Customers</span>
                <span>Customize Message</span>
                <span>Launch Campaign</span>
            </div>
        </div>

        <!-- Step 1: Upload Customers -->
        <div id="step-1" class="step-content bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Step 1: Upload Your Customer List</h3>
            <p class="text-gray-600 mb-6">Upload a CSV file with your customer information. Required columns: Name, Phone. Optional: Email</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <div class="mb-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <p class="text-sm text-gray-600 mb-4">
                    <span class="font-semibold">Click to upload</span> or drag and drop your CSV file
                </p>
                <input type="file" id="csv-file" accept=".csv" class="hidden">
                <button onclick="document.getElementById('csv-file').click()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Choose File
                </button>
            </div>
            
            <div id="upload-results" class="mt-4 hidden">
                <h4 class="font-semibold text-gray-800 mb-2">Upload Results:</h4>
                <div id="customer-preview" class="bg-gray-50 rounded-lg p-4"></div>
            </div>
            
            <!-- Manual Entry Option -->
            <div class="mt-6 text-center">
                <button id="show-manual-entry" class="text-blue-600 hover:text-blue-800 text-sm underline">
                    Don't have a file? Click here to manually add customers.
                </button>
            </div>
            
            <!-- Manual Customer Entry Form -->
            <div id="manual-entry-section" class="mt-6 hidden">
                <h4 class="font-semibold text-gray-800 mb-4">Add Customers Manually</h4>
                <div id="manual-customers-container">
                    <!-- Customer rows will be added here -->
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <button id="add-customer-row" class="text-blue-600 hover:text-blue-800 text-sm">
                        + Add Another Customer
                    </button>
                    <button id="save-manual-customers" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50" disabled>
                        Save Customers
                    </button>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button id="next-step-1" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Next: Customize Message
                </button>
            </div>
        </div>

        <!-- Step 2: Customize Message -->
        <div id="step-2" class="step-content bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Step 2: Customize Your SMS Message</h3>
            <p class="text-gray-600 mb-6">Edit the message that will be sent to your customers. Use {name} to personalize each message.</p>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">SMS Message Template</label>
                <textarea id="sms-message" rows="6" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Loading default message..."></textarea>
                <p class="text-sm text-gray-500 mt-2">Available placeholders: {name}</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-800 mb-2">Preview:</h4>
                <div id="message-preview" class="text-sm text-gray-600 whitespace-pre-wrap"></div>
            </div>
            
            <div class="flex justify-between">
                <button id="prev-step-2" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">
                    Previous
                </button>
                <button id="next-step-2" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                    Next: Launch Campaign
                </button>
            </div>
        </div>

        <!-- Step 3: Launch Campaign -->
        <div id="step-3" class="step-content bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Step 3: Launch Your Campaign</h3>
            <p class="text-gray-600 mb-6">Review your campaign details and launch when ready.</p>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-800 mb-2">Campaign Summary:</h4>
                <div class="space-y-2 text-sm text-gray-600">
                    <p>ðŸ“± <span id="customer-count">0</span> customers will receive SMS</p>
                    <p>ðŸ’¬ Message preview available in Step 2</p>
                    <p>ðŸš€ Campaign will start immediately</p>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Name (Optional)</label>
                <input type="text" id="campaign-name" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Enter campaign name...">
            </div>
            
            <div class="flex justify-between">
                <button id="prev-step-3" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">
                    Previous
                </button>
                <button id="launch-campaign" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">
                    ðŸš€ Launch Campaign
                </button>
            </div>
        </div>

        <!-- Campaign Results -->
        <div id="campaign-results" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Campaign Results</h3>
            <div id="results-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
            <div id="results-details" class="overflow-x-auto"></div>
            <div class="mt-6 text-center">
                <a href="/dashboard" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                    Go to Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let uploadedCustomers = [];
        let customMessage = '';
        let manualCustomers = [];
        let customerRowCount = 0;

        // File upload handling
        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadCustomers(file);
            }
        });

        // Manual entry handling
        document.getElementById('show-manual-entry').addEventListener('click', function() {
            document.getElementById('manual-entry-section').classList.remove('hidden');
            // Add first customer row
            addCustomerRow();
            this.style.display = 'none';
        });

        document.getElementById('add-customer-row').addEventListener('click', function() {
            if (customerRowCount < 5) {
                addCustomerRow();
            }
            if (customerRowCount >= 5) {
                this.style.display = 'none';
            }
        });

        document.getElementById('save-manual-customers').addEventListener('click', function() {
            saveManualCustomers();
        });

        function addCustomerRow() {
            customerRowCount++;
            const container = document.getElementById('manual-customers-container');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'customer-row grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 border border-gray-200 rounded-lg';
            rowDiv.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                    <input type="text" class="customer-name w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Customer name" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                    <input type="tel" class="customer-phone w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="+1234567890" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" class="customer-email w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="customer@example.com">
                </div>
                ${customerRowCount > 1 ? `
                <div class="md:col-span-3 text-right">
                    <button type="button" onclick="removeCustomerRow(this)" class="text-red-600 hover:text-red-800 text-sm">
                        Remove Customer
                    </button>
                </div>
                ` : ''}
            `;
            container.appendChild(rowDiv);
            
            // Add event listeners to validate form
            const inputs = rowDiv.querySelectorAll('input[required]');
            inputs.forEach(input => {
                input.addEventListener('input', validateManualForm);
            });
            
            validateManualForm();
        }

        function removeCustomerRow(button) {
            const row = button.closest('.customer-row');
            row.remove();
            customerRowCount--;
            
            // Show add button if we're under 5
            if (customerRowCount < 5) {
                document.getElementById('add-customer-row').style.display = 'inline-block';
            }
            
            validateManualForm();
        }

        function validateManualForm() {
            const rows = document.querySelectorAll('.customer-row');
            let isValid = false;
            
            rows.forEach(row => {
                const name = row.querySelector('.customer-name').value.trim();
                const phone = row.querySelector('.customer-phone').value.trim();
                if (name && phone) {
                    isValid = true;
                }
            });
            
            document.getElementById('save-manual-customers').disabled = !isValid;
        }

        function saveManualCustomers() {
            const rows = document.querySelectorAll('.customer-row');
            const customers = [];
            
            rows.forEach(row => {
                const name = row.querySelector('.customer-name').value.trim();
                const phone = row.querySelector('.customer-phone').value.trim();
                const email = row.querySelector('.customer-email').value.trim();
                
                if (name && phone) {
                    customers.push({ name, phone, email });
                }
            });
            
            if (customers.length === 0) {
                alert('Please add at least one customer with name and phone.');
                return;
            }
            
            // Save to backend
            fetch('/onboarding/add-manual-customers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ customers: customers })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedCustomers = data.customers;
                    showManualResults(data);
                    document.getElementById('next-step-1').disabled = false;
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving customers');
            });
        }

        function showManualResults(data) {
            const resultsDiv = document.getElementById('upload-results');
            const previewDiv = document.getElementById('customer-preview');
            
            previewDiv.innerHTML = `
                <p class="text-green-600 font-semibold mb-2">âœ… ${data.message}</p>
                <div class="space-y-2">
                    ${data.customers.map(customer => `
                        <div class="flex justify-between text-sm">
                            <span>${customer.name}</span>
                            <span>${customer.phone}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            resultsDiv.classList.remove('hidden');
            
            // Hide manual entry section
            document.getElementById('manual-entry-section').classList.add('hidden');
        }

        function uploadCustomers(file) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/onboarding/upload-customers', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedCustomers = data.customers;
                    showUploadResults(data);
                    document.getElementById('next-step-1').disabled = false;
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading file');
            });
        }

        function showUploadResults(data) {
            const resultsDiv = document.getElementById('upload-results');
            const previewDiv = document.getElementById('customer-preview');
            
            previewDiv.innerHTML = `
                <p class="text-green-600 font-semibold mb-2">âœ… ${data.message}</p>
                <div class="space-y-2">
                    ${data.customers.slice(0, 5).map(customer => `
                        <div class="flex justify-between text-sm">
                            <span>${customer.name}</span>
                            <span>${customer.phone}</span>
                        </div>
                    `).join('')}
                    ${data.customers.length > 5 ? `<p class="text-gray-500 text-sm">... and ${data.customers.length - 5} more customers</p>` : ''}
                </div>
            `;
            
            resultsDiv.classList.remove('hidden');
        }

        // Load default message
        function loadDefaultMessage() {
            fetch('/onboarding/get-default-message')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('sms-message').value = data.message;
                    updateMessagePreview();
                });
        }

        function updateMessagePreview() {
            const message = document.getElementById('sms-message').value;
            const preview = message.replace('{name}', 'John Doe');
            document.getElementById('message-preview').textContent = preview;
        }

        // Step navigation
        document.getElementById('next-step-1').addEventListener('click', function() {
            if (uploadedCustomers.length === 0) {
                alert('Please upload customers first');
                return;
            }
            showStep(2);
            loadDefaultMessage();
        });

        document.getElementById('prev-step-2').addEventListener('click', function() {
            showStep(1);
        });

        document.getElementById('next-step-2').addEventListener('click', function() {
            const message = document.getElementById('sms-message').value.trim();
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            // Save message
            fetch('/onboarding/customize-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({message: message})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    customMessage = message;
                    document.getElementById('customer-count').textContent = uploadedCustomers.length;
                    showStep(3);
                } else {
                    alert('Error: ' + data.error);
                }
            });
        });

        document.getElementById('prev-step-3').addEventListener('click', function() {
            showStep(2);
        });

        document.getElementById('launch-campaign').addEventListener('click', function() {
            const campaignName = document.getElementById('campaign-name').value.trim();
            
            if (!confirm(`Are you sure you want to send SMS to ${uploadedCustomers.length} customers?`)) {
                return;
            }
            
            // Disable button and show loading
            const button = document.getElementById('launch-campaign');
            button.disabled = true;
            button.textContent = 'Launching...';
            
            fetch('/onboarding/launch-campaign', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({campaign_name: campaignName})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCampaignResults(data);
                } else {
                    alert('Error: ' + data.error);
                    button.disabled = false;
                    button.textContent = 'ðŸš€ Launch Campaign';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error launching campaign');
                button.disabled = false;
                button.textContent = 'ðŸš€ Launch Campaign';
            });
        });

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Show current step
            document.getElementById(`step-${step}`).classList.remove('hidden');
            
            // Update progress
            currentStep = step;
            document.getElementById('current-step').textContent = step;
            document.getElementById('progress-bar').style.width = `${(step / 3) * 100}%`;
        }

        function showCampaignResults(data) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Show results
            document.getElementById('campaign-results').classList.remove('hidden');
            
            // Update progress to 100%
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('current-step').textContent = 'Complete';
            
            // Show summary
            const summaryDiv = document.getElementById('results-summary');
            summaryDiv.innerHTML = `
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-green-800">Successfully Sent</h4>
                    <p class="text-2xl font-bold text-green-600">${data.summary.sent}</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-red-800">Failed</h4>
                    <p class="text-2xl font-bold text-red-600">${data.summary.failed}</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-800">Total Customers</h4>
                    <p class="text-2xl font-bold text-blue-600">${data.summary.total}</p>
                </div>
            `;
            
            // Show detailed results
            const detailsDiv = document.getElementById('results-details');
            detailsDiv.innerHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Message</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${data.results.map(result => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.phone}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${result.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${result.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900">${result.message}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Message preview update
        document.getElementById('sms-message').addEventListener('input', updateMessagePreview);
    </script>
</body>
</html>